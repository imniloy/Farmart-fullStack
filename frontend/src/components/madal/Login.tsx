"use client";
import React, { useState } from "react";
import Image from "next/image";
import LoginImage from "../assets/images/login.jpeg";
import { useAppDispatch, useAppSelector } from "@/redux/hooks";
import {
  setAuthMadalOpen,
  setIsRegisterOpen,
} from "@/redux/features/uiSlider/slices";
import { toast } from "react-toastify";
import BeatLoader from "react-spinners/BeatLoader";
import { userLoggedIn } from "@/redux/features/auth/authSlice";
import Cookies from "js-cookie";
import { verifyAuthOnClient } from "@/services/verifyAuth";

const Login = (): React.ReactNode => {
  const [email, setEmail] = useState<string>("");
  const [password, setPassword] = useState<string>("");
  const [loading, setLoading] = useState<boolean>(false);
  const dispatch = useAppDispatch();

  const openRegisterFrom = () => {
    dispatch(setIsRegisterOpen(true));
  };

  const HandleLogin = async (
    event: React.FormEvent<HTMLFormElement>
  ): Promise<void> => {
    event.preventDefault();
    if (loading) return;
    if (email.trim().length === 0 || password.trim().length === 0) return;

    try {
      setLoading(true);
      const payload = { identifier: email, password };
      const response = await fetch(`/api/auth/login`, {
        method: "POST",
        cache: "no-store",
        body: JSON.stringify(payload),
      });
      const data = await response.json();

      if (data.status === 400) {
        setEmail("");
        setPassword("");
        toast.error("Invalid user or password!", {
          position: "top-center",
          autoClose: 3000,
          hideProgressBar: false,
          closeOnClick: false,
          pauseOnHover: false,
          pauseOnFocusLoss: true,
          draggable: true,
          theme: "light",
        });
        return;
      } else if (data.status === 200) {
        const { user } = data;

        toast.success(`${user.username} successfully logged in!`, {
          position: "top-center",
          autoClose: 3000,
          hideProgressBar: false,
          closeOnClick: false,
          pauseOnHover: false,
          pauseOnFocusLoss: true,
          draggable: true,
          theme: "light",
        });
        const userToken = Cookies.get("farmart_client_token");
        const verifyUser = userToken && (await verifyAuthOnClient(userToken));
        verifyUser && dispatch(userLoggedIn({ userToken, user: verifyUser }));
        setEmail("");
        setPassword("");
        dispatch(setAuthMadalOpen(false));
      }
    } catch (e) {
      if (e instanceof Error) {
        toast.error("Something worng happens!", {
          position: "top-center",
          autoClose: 3000,
          hideProgressBar: false,
          closeOnClick: false,
          pauseOnHover: false,
          pauseOnFocusLoss: true,
          draggable: true,
          theme: "light",
        });
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="h-full w-full flex items-center md:h-[440px]">
      <div className="relative hidden md:block md:w-1/2 lg:w-[55%] h-full">
        <Image
          src={LoginImage}
          alt=""
          fill
          sizes="(min-width: 768px) 400px, (min-width: 1024px) 515px, (min-width: 1550px) 530px"
          style={{
            objectFit: "cover",
          }}
        />
      </div>

      <div className="px-4 lg:px-8 py-8 lg:py-10 w-full md:w-1/2 lg:w-[45%] h-full">
        <div className="">
          <div className="w-full flex justify-center items-center space-x-2 cursor-pointer">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="26"
              height="28"
              viewBox="0 0 26 28"
              fill="none"
            >
              <path
                d="M9.25398 14.9142C8.7669 15.106 8.21679 14.8968 7.97616 14.426L3.50651 5.69596C2.98506 4.66142 3.38045 3.40015 4.40044 2.87123C4.46347 2.84217 4.52075 2.81311 4.58383 2.78405C5.7356 2.31326 7.002 2.9991 7.32289 4.1848L7.3286 4.20224L9.86711 13.682C9.99893 14.1876 9.73535 14.7224 9.25398 14.9142Z"
                fill="#F98500"
              />
              <path
                d="M9.0138 10.5144L7.7474 11.02C7.51247 11.1072 7.24889 10.991 7.15145 10.7527C7.05976 10.5144 7.17439 10.2412 7.40932 10.1482L8.7674 9.60767L9.0138 10.5144Z"
                fill="#FA6D00"
              />
              <path
                d="M9.50647 12.3336L8.41773 12.7463C8.18281 12.8277 7.92494 12.7172 7.82178 12.479C7.7301 12.2406 7.84473 11.9675 8.08536 11.8745L9.26584 11.4269L9.50647 12.3336Z"
                fill="#FA6D00"
              />
              <path
                d="M14.6467 6.376C14.2627 6.10865 14.0679 5.63782 14.1539 5.16705C14.3659 4.08597 13.6783 3.03395 12.6067 2.81309C12.5952 2.81309 12.5781 2.80728 12.5666 2.80728C12.1253 2.73172 11.7586 2.41205 11.6211 1.97612C11.5867 1.87151 11.5466 1.76688 11.5007 1.66808C11.0137 0.679996 9.83323 0.278951 8.85906 0.772992C7.93651 1.23797 7.52393 2.34811 7.91356 3.31294C8.11417 3.81279 8.21156 4.26615 7.87348 4.74857C7.24316 5.64946 7.45514 6.89911 8.34338 7.53265C8.34909 7.53844 8.36056 7.54424 8.36627 7.55008C8.7502 7.82322 8.93356 8.29984 8.84188 8.76482C8.63562 9.84591 9.33467 10.8979 10.4063 11.1071C11.369 11.2931 12.3144 10.741 12.6411 9.8052C13.6152 10.2993 14.7957 9.89241 15.2827 8.91011C15.7182 8.02085 15.4489 6.94561 14.6467 6.376Z"
                fill="#598C44"
              />
              <path
                d="M19.1163 7.97436C18.8584 7.5791 18.8526 7.06762 19.1048 6.66662C19.7065 5.74825 19.4544 4.50444 18.549 3.89416C18.5375 3.88835 18.526 3.87673 18.5146 3.87091C17.953 3.51055 17.9931 2.99908 17.9473 2.41204C17.8671 1.31353 16.9158 0.488188 15.8328 0.569562C14.8071 0.65093 14.0106 1.51696 14.0106 2.56316C14.0106 3.1037 13.9303 3.55705 13.4433 3.87673C12.5264 4.46957 12.2571 5.7076 12.8473 6.63756C12.8531 6.64335 12.8588 6.65499 12.8645 6.66078C13.1166 7.06183 13.1166 7.57331 12.8531 7.96857C12.2628 8.89268 12.5207 10.1307 13.4318 10.7352C14.2512 11.2757 15.34 11.1246 15.9818 10.3806C16.7038 11.2059 17.9473 11.2873 18.761 10.5608C19.4944 9.90984 19.6434 8.80553 19.1163 7.97436Z"
                fill="#5F9548"
              />
              <path
                d="M22.182 13.589L16.6809 11.7291L19.7122 2.51088C20.0789 1.40075 21.1963 0.540536 22.3596 0.569593C23.0816 0.587034 23.7578 0.726528 24.3251 1.19151C25.2419 1.93547 25.603 3.17929 25.2305 4.30687L22.182 13.589Z"
                fill="#FFB531"
              />
              <path
                d="M18.5149 8.93924V25.6785H4.76221V8.93924L6.13747 9.8692L7.51274 8.93924L8.88801 9.8692L10.2633 8.93924L11.6385 9.8692L13.0138 8.93924L14.3891 9.8692L15.7643 8.93924L17.1396 9.8692L18.5149 8.93924Z"
                fill="#FFB531"
              />
              <path
                d="M18.5149 12.7928V25.6785H4.76221V22.8596C9.81056 21.1391 14.8131 18.0063 18.5149 12.7928Z"
                fill="#FCAC1F"
              />
              <path
                d="M24.0157 8.93924V25.6785H18.5146V8.93924L19.8899 9.8692L21.2652 8.93924L22.6405 9.8692L24.0157 8.93924Z"
                fill="#F98500"
              />
              <path
                d="M4.84758 27.5384C6.87302 27.5384 8.51496 25.8729 8.51496 23.8185C8.51496 21.7641 6.87302 20.0987 4.84758 20.0987C2.82212 20.0987 1.18018 21.7641 1.18018 23.8185C1.18018 25.8729 2.82212 27.5384 4.84758 27.5384Z"
                fill="#F35244"
              />
              <path
                d="M12.5549 17.7738L13.0133 18.7038C12.446 19.2792 12.2168 20.1162 12.4116 20.9124L12.5549 21.4937H10.7212V20.7846C10.7212 19.5117 11.4317 18.3434 12.5549 17.7738Z"
                fill="#5F9548"
              />
              <path
                d="M9.86758 27.5384C9.28882 27.5384 8.77313 27.1548 8.60695 26.591L7.57547 23.0979C7.28899 22.1272 7.91931 21.0287 8.97939 21.0287C9.49513 21.0287 9.97074 21.3019 10.2343 21.7494L11.1798 23.3536V26.2074C11.1798 26.9397 10.5896 27.5384 9.86758 27.5384Z"
                fill="#FA9F0C"
              />
              <path
                d="M13.4089 27.5384C13.9877 27.5384 14.5034 27.1548 14.6696 26.591L15.701 23.0979C15.9933 22.1156 15.3515 21.0287 14.2971 21.0287C13.7814 21.0287 13.3058 21.3019 13.0422 21.7494L12.0967 23.3536V26.2074C12.0967 26.9397 12.6869 27.5384 13.4089 27.5384Z"
                fill="#FA9F0C"
              />
              <path
                d="M11.6382 21.0287C12.4003 21.0287 13.0135 21.6506 13.0135 22.4236V26.1435C13.0135 26.9165 12.4003 27.5384 11.6382 27.5384C10.8761 27.5384 10.2629 26.9165 10.2629 26.1435V22.4236C10.2629 21.6506 10.8761 21.0287 11.6382 21.0287Z"
                fill="#FFB531"
              />
              <path
                d="M24.6116 0.831149C23.7636 0.139494 22.6003 -0.0697469 21.4943 0.255738C20.4171 0.57541 19.6091 1.34844 19.2767 2.36558L17.4259 8.00343L17.2081 7.67795L16.4402 8.19527V6.31792L17.7124 5.45769L17.2024 4.68465L16.4345 5.20197V3.06886H15.5177V5.19613L14.7555 4.67886L14.2456 5.45189L15.5177 6.31208V8.18942L14.7555 7.67215L14.2456 8.44519L14.9504 8.92181L14.3831 9.30537L13.2599 8.54982C13.2084 8.51491 13.1568 8.49169 13.0995 8.48005C13.1339 8.3929 13.1797 8.3057 13.2313 8.22434C13.5866 7.67215 13.5866 6.96305 13.237 6.40507C12.9161 5.91103 12.9275 5.17291 13.2599 4.67886C13.4032 4.46961 13.9877 4.04532 14.1424 3.83608C14.4461 3.42922 14.4805 2.96424 14.5148 2.55738C14.5378 2.23771 14.5607 1.95873 14.6982 1.74367C15.1394 1.02877 16.0735 0.813713 16.7783 1.26126C16.9273 1.35425 17.0534 1.47631 17.1623 1.60999C17.4087 1.92385 17.4316 2.23771 17.4602 2.66201C17.4717 2.80731 17.4832 2.96424 17.5004 3.12699L18.4114 3.01074C18.3942 2.87124 18.3828 2.73175 18.3771 2.59807C18.3427 2.09241 18.3026 1.57512 17.8843 1.03458C17.0534 -0.0348708 15.5291 -0.215054 14.4748 0.621908C14.257 0.796278 14.0679 1.00552 13.9189 1.24382C13.6668 1.65068 13.6324 2.09241 13.598 2.47602C13.5923 2.5632 13.5866 2.64457 13.5751 2.72594C13.2943 2.53414 12.9734 2.40046 12.6353 2.33652C12.3603 2.29002 12.131 2.09241 12.0451 1.82505C11.8446 1.19151 11.409 0.668406 10.8246 0.36617C10.2515 0.0581251 9.58106 0 8.96222 0.203427C8.05109 0.511477 7.3864 1.3775 7.30619 2.37139C7.27753 2.74919 7.36921 3.08049 7.4609 3.37691C7.03113 2.66201 6.28042 2.20865 5.45526 2.15634L5.4725 0.0929958L4.55565 0.0871822L4.54418 1.42981L3.99406 0L3.15744 0.354548L3.70755 1.78436L2.80216 0.8079L2.13745 1.44144L3.52991 2.95262C2.77351 3.74308 2.59587 4.92878 3.10014 5.90523L4.05137 7.76515L4.86508 7.33503L3.91384 5.47512C3.50699 4.67886 3.81069 3.69658 4.59573 3.28392C5.38081 2.87124 6.34921 3.17929 6.75608 3.97557C6.80763 4.08019 6.84777 4.18481 6.88213 4.30106L6.89932 4.35918L5.42089 4.94621L5.75326 5.81224L7.14 5.2659V5.27169C7.05403 5.60302 7.03113 5.94594 7.0884 6.28886L6.09134 6.68406L6.42371 7.55009L7.40929 7.16068C7.63851 7.55009 8.0339 7.91044 8.0339 7.91044L6.75608 8.41612L6.90503 8.7939L6.1429 9.31122L5.01979 8.55561C4.80776 8.41033 4.527 8.46841 4.38372 8.68347C4.33215 8.75904 4.30923 8.85203 4.30923 8.93924V18.7038H5.22605V9.80527L5.89079 10.2528C6.0455 10.3574 6.24605 10.3574 6.40076 10.2528L7.52393 9.49721L8.64703 10.2528C8.80175 10.3574 9.00235 10.3574 9.15706 10.2528L10.2802 9.49721L11.4033 10.2528C11.558 10.3574 11.7586 10.3574 11.9133 10.2528L13.0365 9.49721L14.1596 10.2528C14.3143 10.3574 14.5148 10.3574 14.6696 10.2528L15.7927 9.49721L16.9159 10.2528C17.0706 10.3574 17.2711 10.3574 17.4259 10.2528L18.0905 9.80527V25.2135H16.2568V26.1435H24.05C24.3022 26.1435 24.5085 25.9342 24.5085 25.6785V8.93924C24.5085 8.79974 24.4454 8.67183 24.3423 8.58468L25.7004 4.45799C26.0957 3.14442 25.6717 1.69717 24.6116 0.831149ZM12.4806 6.92819C12.5207 6.99212 12.5494 7.06189 12.5666 7.13746L12.2514 7.60823L11.5523 5.86453L12.1655 4.94621C12.005 5.61461 12.1081 6.35858 12.4806 6.92819ZM9.28312 9.04966C9.40346 8.55561 9.30601 8.03835 9.02525 7.61987C8.7559 7.22461 8.32614 6.95141 8.1084 6.52135C7.99382 6.29465 7.94798 6.03309 7.97659 5.77738C8.04538 5.20777 8.46943 4.73115 8.53245 4.16156C8.5783 3.74308 8.41211 3.33622 8.32614 2.92355C8.12559 2.01104 8.69288 1.08689 9.66133 1.04039C10.1312 1.02295 10.5782 1.22638 10.8761 1.59256C11.1397 1.92385 11.26 2.35977 11.5237 2.69688C11.7185 2.9468 11.9821 3.12699 12.28 3.21417C12.5723 3.30135 12.9161 3.31298 13.1109 3.55128C12.7728 3.79539 12.4978 4.11507 12.3087 4.49287L11.6554 4.05113L11.1397 4.80671L10.349 2.848L9.50662 3.19673L10.2916 5.16127L9.3977 4.98691L9.21433 5.8936L10.687 6.23072L11.4033 7.9395L10.5094 7.76515L10.4005 8.31149C10.3948 8.31733 9.51804 8.87531 9.28312 9.04966ZM10.8761 8.7939L11.8216 8.99153L11.8847 9.14845L11.6383 9.31122L10.8761 8.7939ZM16.7898 9.07288L17.1451 8.82881L17.0133 9.22402L16.7898 9.07288ZM18.973 9.80527L19.6378 10.2528C19.7925 10.3574 19.993 10.3574 20.1477 10.2528L20.8125 9.80527V22.691L18.9788 24.5509V9.80527H18.973ZM23.5572 9.80527V24.5509L21.7235 22.691V9.80527L22.3883 10.2528C22.543 10.3574 22.7436 10.3574 22.8983 10.2528L23.5572 9.80527ZM21.2651 23.5454L22.9097 25.2135H19.6206L21.2651 23.5454ZM24.795 4.16156L23.2363 8.90432L22.6404 9.30537L21.5173 8.54982C21.3626 8.44519 21.162 8.44519 21.0073 8.54982L19.8841 9.30537C19.8841 9.30537 18.7381 8.53234 18.7266 8.52655C18.5776 8.44519 18.3942 8.45683 18.2567 8.54982L18.188 8.59632L20.142 2.65619C20.3827 1.92966 20.9672 1.38332 21.7522 1.14501C22.5659 0.900896 23.4197 1.05202 24.0386 1.55187C24.8007 2.17959 25.1044 3.21998 24.795 4.16156Z"
                fill="black"
              />
              <path
                d="M20.7227 3.83815L23.4742 3.37393L23.6246 4.29087L20.873 4.75511L20.7227 3.83815Z"
                fill="black"
              />
              <path
                d="M19.8054 6.62654L22.557 6.16235L22.7074 7.07929L19.9558 7.54347L19.8054 6.62654Z"
                fill="black"
              />
              <path
                d="M14.3028 20.5637C13.7985 20.5579 13.3115 20.7613 12.9561 21.1275C12.9504 21.1217 12.9447 21.1159 12.939 21.1043L12.8645 20.7962C12.8645 20.7904 12.8645 20.7904 12.8588 20.7846C12.6811 20.151 13.0364 19.349 13.3458 19.0351C13.4834 18.8956 13.5177 18.6747 13.4318 18.5004L12.9734 17.5704C12.8588 17.3379 12.5837 17.2449 12.3602 17.3612C11.0766 18.0063 10.2687 19.3373 10.2744 20.7846V21.0345C10.1655 20.9531 10.0452 20.8776 9.92485 20.8078C9.03666 20.3254 7.88489 20.6276 7.35768 21.4762C7.05397 21.9703 6.97376 22.6387 7.14565 23.2257L7.7416 25.2426C6.95081 26.8526 5.02544 27.5093 3.43817 26.7131C1.86807 25.9226 1.21482 23.9988 1.97122 22.3946C1.98267 22.3713 1.99414 22.3481 2.0056 22.3248L2.02279 23.9058L2.93964 23.8941L2.91098 21.9587L4.73896 22.0459L4.7848 21.1159L3.19177 21.0403C3.66738 20.7439 4.21749 20.5811 4.77333 20.5637C5.43802 20.5463 6.09128 20.7381 6.64139 21.1159L7.15136 20.3429C6.11994 19.6396 4.83065 19.4478 3.64446 19.814L3.83929 19.349L2.99694 18.9828L2.36661 20.4707C2.32077 20.5056 2.26919 20.5463 2.22335 20.587L0.825161 19.1688L0.177637 19.8255L1.58729 21.2554C1.55864 21.296 1.52998 21.3368 1.50133 21.3775L0 22.0284L0.361006 22.8828L0.888192 22.6503C0.252132 24.8706 1.51279 27.1897 3.70176 27.8348C5.14578 28.2591 6.70442 27.8523 7.77026 26.7712C7.87913 26.6607 7.98229 26.5387 8.07968 26.4167L8.17137 26.7189C8.45218 27.6721 9.43777 28.2068 10.3776 27.922C10.5093 27.8813 10.6297 27.829 10.75 27.7593C11.3058 28.0732 11.982 28.0732 12.5379 27.7593C13.386 28.2533 14.4689 27.9511 14.956 27.0909C15.0248 26.9746 15.0764 26.8467 15.1165 26.7131L16.1479 23.2199C16.2109 22.9874 16.2396 22.7433 16.2282 22.4992C16.2224 21.4355 15.3629 20.5637 14.3028 20.5637ZM12.366 18.4306L12.4691 18.6399C12.1081 19.1456 11.8502 19.8837 11.8961 20.5811C11.7642 20.5579 11.4033 20.5405 11.1855 20.6219C11.2314 19.7442 11.6669 18.9421 12.366 18.4306ZM9.04813 26.4573L8.01666 22.9642C7.91926 22.6329 7.9651 22.2376 8.12553 21.9761C8.38916 21.546 9.02519 21.3833 9.48361 21.6332C9.70135 21.7494 9.78732 21.8308 9.87329 21.9412C9.83316 22.0982 9.81027 22.2609 9.81027 22.4236V26.1435C9.81027 26.4632 9.89048 26.777 10.0452 27.056C9.60395 27.149 9.17419 26.8874 9.04813 26.4573ZM10.7213 26.1435V22.4236C10.7213 21.9122 11.1339 21.4937 11.6382 21.4937C12.1425 21.4937 12.555 21.9122 12.555 22.4236V26.1435C12.555 26.6549 12.1425 27.0734 11.6382 27.0734C11.1339 27.0734 10.7213 26.6549 10.7213 26.1435ZM15.2654 22.9642L14.234 26.4573C14.108 26.8874 13.6724 27.149 13.237 27.056C13.3917 26.777 13.4719 26.4632 13.4719 26.1435V22.4236C13.4719 22.2783 13.4547 22.1389 13.4203 21.9994C13.5407 21.8134 13.8157 21.4937 14.297 21.4937C14.8529 21.4937 15.2999 21.9529 15.2999 22.5108C15.3113 22.6619 15.2999 22.8189 15.2654 22.9642Z"
                fill="black"
              />
            </svg>
            <p className="font-semibold text-lg sm:text-xl md:text-[22px] text-color-black">
              Farmart Grocery
            </p>
          </div>

          <form
            action=""
            className="mt-8 mb-6 w-full space-y-3 sm:space-y-4"
            onSubmit={HandleLogin}
          >
            <div className="w-full">
              <label
                htmlFor="email"
                className="block font-normal text-[13px] leading-none mb-3 cursor-pointer text-color-black opacity-80 font-inter"
              >
                Email Address
              </label>
              <input
                id="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                type="email"
                className="py-3 px-4 w-full appearance-none transition-all  ease-in text-input text-[13px] outline-none lg:text-sm font-body rounded placeholder:font-normal  placeholder-[#B3B3B3] text-color-black focus:outline-none border-2 focus:border-[#02b292] font-normal font-inter"
              />
            </div>

            <div className="w-full">
              <label
                htmlFor="password"
                className="block font-normal text-[13px] leading-none mb-3 cursor-pointer text-color-black opacity-80 font-inter"
              >
                Password
              </label>
              <input
                id="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                // type="password"
                type="text"
                className="py-3 px-4 w-full appearance-none transition-all  ease-in text-input text-[13px] outline-none lg:text-sm font-body rounded placeholder:font-normal  placeholder-[#B3B3B3] text-color-black focus:outline-none border-2 focus:border-[#02b292] font-normal font-inter"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="bg-[#02b290] flex justify-center items-center py-3 px-4 text-white rounded w-full text-sm md:text-base"
            >
              {loading ? <BeatLoader color="#fff" size={12} /> : "Sign In"}
            </button>
          </form>

          <div className=" text-sm text-center sm:text-15px text-gray-600 font-normal">
            Donâ€™t have an account?
            <button
              onClick={openRegisterFrom}
              type="button"
              className="text-sm font-medium text-brand sm:text-base ml-1  hover:no-underline focus:outline-none text-[#02b290] inline-block"
            >
              Create Account
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Login;
